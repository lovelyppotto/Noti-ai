pipeline {
  agent any

  environment {
    DOCKER_IMAGE = "sseon701/noti-ai"
    DOCKER_TAG = "latest"
    SSH_USER = "ubuntu"
    SSH_CREDENTIAL = 'ec2'
    GIT_REPO = 'https://lab.ssafy.com/noti/noti-ai.git'
  }

  stages {
    stage('Checkout Code') {
      steps {
        git branch: 'develop',
            url: "${GIT_REPO}",
            credentialsId: 'GITLAB_CREDENTIALS_ID'
      }
    }

    stage('Build & Push Docker Image') {
      steps {
        script {
          withCredentials([
            string(credentialsId: 'DOCKER_USERNAME', variable: 'DOCKER_USERNAME'),
            string(credentialsId: 'DOCKER_PASSWORD', variable: 'DOCKER_PASSWORD')
          ]) {
            sh '''
              docker build --no-cache -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
              echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
              docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
            '''
          }
        }
      }
    }

    stage('Upload .env to EC2') {
      steps {
        script {
          withCredentials([
            string(credentialsId: 'EC2_IP', variable: 'EC2_IP'),
            string(credentialsId: 'MONGODB_URI', variable: 'MONGODB_URI'),
            string(credentialsId: 'MONGODB_DB_NAME', variable: 'MONGODB_DB_NAME'),
            string(credentialsId: 'REDIS_HOST', variable: 'REDIS_HOST'),
            string(credentialsId: 'REDIS_PORT', variable: 'REDIS_PORT'),
            string(credentialsId: 'REDIS_USERNAME', variable: 'REDIS_USERNAME'),
            string(credentialsId: 'REDIS_PASSWORD', variable: 'REDIS_PASSWORD'),
            string(credentialsId: 'REDIS_DB_BROKER', variable: 'REDIS_DB_BROKER'),
            string(credentialsId: 'REDIS_DB_BACKEND', variable: 'REDIS_DB_BACKEND'),
            string(credentialsId: 'OPENAI_API_KEY', variable: 'OPENAI_API_KEY')
          ]) {
            writeFile file: '.env', text: """
MONGODB_URI=${MONGODB_URI}
MONGODB_DB_NAME=${MONGODB_DB_NAME}

REDIS_HOST=${REDIS_HOST}
REDIS_PORT=${REDIS_PORT}
REDIS_USERNAME=${REDIS_USERNAME}
REDIS_PASSWORD=${REDIS_PASSWORD}
REDIS_DB_BROKER=${REDIS_DB_BROKER}
REDIS_DB_BACKEND=${REDIS_DB_BACKEND}

OPENAI_API_KEY=${OPENAI_API_KEY}
"""
            sshagent(credentials: [SSH_CREDENTIAL]) {
              sh '''
                scp -o StrictHostKeyChecking=no .env ${SSH_USER}@${EC2_IP}:~/noti-ai/.env
              '''
            }
          }
        }
      }
    }

    stage('Deploy to GPU Server') {
      steps {
        script {
          withCredentials([
            string(credentialsId: 'EC2_IP', variable: 'EC2_IP')
          ]) {
            sshagent(credentials: [SSH_CREDENTIAL]) {
              sh '''
                ssh -o StrictHostKeyChecking=no ${SSH_USER}@${EC2_IP} '
                  mkdir -p ~/noti-ai && cd ~/noti-ai

                  docker compose down || true
                  docker compose pull
                  docker compose up -d
                '
              '''
            }
          }
        }
      }
    }

    stage('Verify Deployment') {
      steps {
        script {
          withCredentials([string(credentialsId: 'EC2_IP', variable: 'EC2_IP')]) {
            sshagent(credentials: [SSH_CREDENTIAL]) {
              sh '''
                ssh -o StrictHostKeyChecking=no ${SSH_USER}@${EC2_IP} '
                  echo "===== Container Status ====="
                  docker ps | grep noti-ai

                  echo "\n===== noti-ai Logs (Last 10 lines) ====="
                  docker logs noti-ai --tail 10

                  echo "\n===== celery-worker Logs (Last 10 lines) ====="
                  docker logs noti-celery-worker --tail 10

                  echo "\n===== GPU Status ====="
                  nvidia-smi --query-gpu=index,name,utilization.gpu,memory.used,memory.total --format=csv,noheader
                '
              '''
            }
          }
        }
      }
    }

    stage('Notify Success') {
      steps {
        script {
          def commitMessage = sh(script: "git log -1 --pretty=format:%s", returnStdout: true).trim()
          def commitAuthor = sh(script: "git log -1 --pretty=format:%an", returnStdout: true).trim()
          def commitHash = sh(script: "git log -1 --pretty=format:%h", returnStdout: true).trim()
          def buildTime = new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("Asia/Seoul"))

          echo "Commit message: ${commitMessage}"
          echo "Commit author: ${commitAuthor}"
          echo "Commit hash: ${commitHash}"
          echo "Build time: ${buildTime}"

          withCredentials([string(credentialsId: 'MATTERMOST_URL', variable: 'MATTERMOST_WEBHOOK')]) {
            def jsonContent = """
            {
            "text": ":rocket: **AI 서버 배포 완료!**\\n\\n:label: 브랜치: main\\n:package: 도커 이미지: ${DOCKER_IMAGE}:${DOCKER_TAG}\\n:bust_in_silhouette: 작성자: ${commitAuthor}\\n:page_facing_up: 커밋 메시지: ${commitMessage}"
            }
            """

            writeFile file: 'notify-ai-success.json', text: jsonContent

            sh '''
              curl_response=$(curl -s -w "\n%{http_code}" -X POST -H "Content-Type: application/json" -d @notify-ai-success.json $MATTERMOST_WEBHOOK)

              status_code=$(echo "$curl_response" | tail -n1)
              response_body=$(echo "$curl_response" | sed '$d')

              echo "Mattermost response status code: $status_code"
              echo "Mattermost response body: $response_body"

              if [ "$status_code" -ne 200 ]; then
                echo "Error sending notification to Mattermost: $response_body"
                exit 1
              else
                echo "Successfully sent notification to Mattermost"
              fi
            '''
          }
        }
      }
    }
  }

  post {
    failure {
      script {
        def commitMessage = sh(script: "git log -1 --pretty=format:%s", returnStdout: true).trim()
        def commitAuthor = sh(script: "git log -1 --pretty=format:%an", returnStdout: true).trim()
        def commitHash = sh(script: "git log -1 --pretty=format:%h", returnStdout: true).trim()
        def buildTime = new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("Asia/Seoul"))

        echo "Sending failure notification..."
        echo "Commit message: ${commitMessage}"
        echo "Commit author: ${commitAuthor}"

        withCredentials([string(credentialsId: 'MATTERMOST_URL', variable: 'MATTERMOST_WEBHOOK')]) {
          def jsonContent = """
          {
          "text": ":x: **AI 서버 배포 실패!**\\n\\n:bust_in_silhouette: 작성자: ${commitAuthor}\\n:page_facing_up: 커밋 메시지: ${commitMessage}\\n:link: <${BUILD_URL}|빌드 상세 보기>\\n@sunju701"
          }
          """

          writeFile file: 'notify-ai-failure.json', text: jsonContent

          sh '''
            curl_response=$(curl -s -w "\n%{http_code}" -X POST -H "Content-Type: application/json" -d @notify-ai-failure.json $MATTERMOST_WEBHOOK)

            status_code=$(echo "$curl_response" | tail -n1)
            response_body=$(echo "$curl_response" | sed '$d')

            echo "Mattermost response status code: $status_code"
            echo "Mattermost response body: $response_body"

            if [ "$status_code" -ne 200 ]; then
              echo "Error sending failure notification to Mattermost: $response_body"
            else
              echo "Successfully sent failure notification to Mattermost"
            fi
          '''
        }
      }
    }
  }
}
